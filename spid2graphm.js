/*SPID2GRAPH version 3.7.0.0*/

var defaultPathLengthLimit=250;
var downstreamNodeFilter="";
var downstreamEdgeFilter="[@Type='Piping' or @Type='DirectConnection']";
var upstreamNodeFilter="";
var upwnstreamEdgeFilter="[@Type='Piping' or @Type='DirectConnection']";
var isolateNodeFilter="/Data[contains(@Subtype,'valve')]";
var isolateEdgeFilter="[@Type='Piping' or @Type='DirectConnection']";

var maxH,maxW,xmlDoc,drawing,selectedElement,offset,transform,xml,selectedPaths,corrector=3.775,minTolerance=10,largo=3,factor=750,parser=new DOMParser,highlightedItem="",lengthExcededCount=0;let currentElement=null;var contextMenu=null,modal=null,propertiesTable=null,svg=document.getElementById("mysvg");let viewBox=[800,-0,1800,1800],isPanning=!1,startX,startY;function makeDraggable(){(svg=document.getElementById("mysvg")).addEventListener("contextmenu",rightClick,!1),svg.addEventListener("mousedown",startDrag,!1),svg.addEventListener("mousemove",drag,!1),svg.addEventListener("mouseup",endDrag,!1),svg.addEventListener("wheel",t=>{t.preventDefault();let e=t.deltaY<0?.9090909090909091:1.1,r=t.clientX/window.innerWidth*viewBox[2]+viewBox[0],n=t.clientY/window.innerHeight*viewBox[3]+viewBox[1];viewBox[2]*=e,viewBox[3]*=e,viewBox[0]=r-(r-viewBox[0])*e,viewBox[1]=n-(n-viewBox[1])*e,svg.setAttribute("viewBox",viewBox.join(" "))})}function showMetadata(t){var e=[],r=xmlDoc.getElementById(t);if(null!=r){console.clear();var n=0;for(e.push({name:"Graph element",value:r.nodeName}),n=0;n<r.attributes.length;n++)e.push({name:r.attributes[n].nodeName,value:r.attributes[n].nodeValue.replaceAll("\\","\\\\")});var l=r.childNodes[0];for(n=0;n<l.attributes.length;n++){var a=l.attributes[n].nodeValue.replaceAll("\\","\\\\");a=a.replace('"','\\"'),e.push({name:l.attributes[n].nodeName,value:a})}}return e}function rightClick(t){t.preventDefault(),highlight(highlightedItem=t.target.getAttribute("id")),currentElement=t.target;let e=t.pageX,r=t.pageY,n=contextMenu.offsetWidth,l=contextMenu.offsetHeight;contextMenu.style.left=(e+n>window.innerWidth?window.innerWidth-n:e)+"px",contextMenu.style.top=(r+l>window.innerHeight?window.innerHeight-l:r)+"px",contextMenu.classList.add("show")}function startDrag(t){0==t.button?"mysvg"==t.target.getAttribute("id")?(isPanning=!0,startX=event.clientX,startY=event.clientY,svg.style.cursor="grabbing"):(highlightedItem&&(highlight(highlightedItem),highlightedItem=""),highlight(highlightedItem=t.target.getAttribute("id")),(t.target.classList.contains("draggable")||t.target.classList.contains("draggable_highlighted"))&&(selectedElement=t.target)):t.button}function drag(t){if(0==t.button){if("mysvg"==t.target.getAttribute("id")){if(!isPanning)return;let e=(event.clientX-startX)*(viewBox[2]/window.innerWidth),r=(event.clientY-startY)*(viewBox[3]/window.innerHeight);viewBox[0]-=e,viewBox[1]-=r,svg.setAttribute("viewBox",viewBox.join(" ")),startX=event.clientX,startY=event.clientY}else if(selectedElement&&"info"!=selectedElement){var n=oMousePosSVG(t);selectedElement.setAttribute("cx",parseInt(n.x)/corrector+"mm"),selectedElement.setAttribute("cy",parseInt(n.y)/corrector+"mm")}}}function endDrag(t){if("mysvg"==t.target.getAttribute("id"))isPanning=!1,(D=document.getElementById("mysvg")).style.cursor="grab";else if(selectedElement){if(0==t.button){var e=oMousePosSVG(t);selectedElement.setAttribute("cx",parseInt(e.x)/corrector+"mm"),selectedElement.setAttribute("cy",parseInt(e.y)/corrector+"mm");var r=null,n=null,l=null,a=null,o=xmlDoc.getElementsByTagName("Edge");for(i=0;i<o.length;i++){r=null,n=null,l=null,a=null;var s="";s="EndNode to StartNode"==o[i].getAttribute("FlowDir")?o[i].getAttribute("EndNode"):o[i].getAttribute("StartNode");var d=document.getElementById(o[i].id);s==selectedElement.id&&"OPC Pairing"!=o[i].childNodes[0].getAttribute("Type")&&null!=d&&(d.setAttribute("x1",selectedElement.getAttribute("cx")),d.setAttribute("y1",selectedElement.getAttribute("cy")),r=d.getAttribute("x1"),n=d.getAttribute("y1"),l=d.getAttribute("x2"),a=d.getAttribute("y2"));var g="";if((g="EndNode to StartNode"==o[i].getAttribute("FlowDir")?o[i].getAttribute("StartNode"):o[i].getAttribute("EndNode"))==selectedElement.id&&"OPC Pairing"!=o[i].childNodes[0].getAttribute("Type")&&null!=d&&(d.setAttribute("x2",selectedElement.getAttribute("cx")),d.setAttribute("y2",selectedElement.getAttribute("cy")),r=d.getAttribute("x1"),n=d.getAttribute("y1"),l=d.getAttribute("x2"),a=d.getAttribute("y2")),!(null==r||null==n||null==l||null==a)){var u=parseFloat(r.replace("mm","")),c=parseFloat(n.replace("mm","")),m=parseFloat(l.replace("mm","")),h=parseFloat(a.replace("mm","")),b=Math.atan((h-c)/(m-u)),A=(parseFloat(u)+parseFloat(m))/2,E=(parseFloat(c)+parseFloat(h))/2,p=m-u,x=h-c,v=document.getElementById("fd1_"+d.getAttribute("id")),y=document.getElementById("fd2_"+d.getAttribute("id"));if(Math.abs(p)<minTolerance&&Math.abs(x)<minTolerance)v.setAttribute("x1",A+"mm"),v.setAttribute("y1",E+"mm"),v.setAttribute("x2",A+"mm"),v.setAttribute("y2",E+"mm"),y.setAttribute("x1",A+"mm"),y.setAttribute("y1",E+"mm"),y.setAttribute("x2",A+"mm"),y.setAttribute("y2",E+"mm");else{var f,w,N=A+largo*Math.sin(b),$=E-largo*Math.cos(b);u<=m?(f=A+2*largo*Math.cos(b),w=E+2*largo*Math.sin(b)):(f=A-2*largo*Math.cos(b),w=E-2*largo*Math.sin(b)),v.setAttribute("x1",A+"mm"),v.setAttribute("y1",E+"mm"),v.setAttribute("x2",N+"mm"),v.setAttribute("y2",$+"mm"),y.setAttribute("x1",N+"mm"),y.setAttribute("y1",$+"mm"),y.setAttribute("x2",f+"mm"),y.setAttribute("y2",w+"mm")}}}selectedElement=!1}else if(2==t.button){var D=document.getElementById("mysvg"),S=document.getElementById("info");null!=S&&D.removeChild(S),selectedElement=!1}}}function GetElementsByAttribute(t,e,r){var n=Array.prototype.slice.call(xmlDoc.getElementsByTagName(t),0),l=function(t){return t.getAttribute(e)==r};return n.where(l)}function oMousePosSVG(t){var e=mysvg.createSVGPoint();e.x=t.clientX,e.y=t.clientY;var r=mysvg.getScreenCTM().inverse();return e.matrixTransform(r)}function FlowDirArrow(t,e,r,n,l,a,o){var s="";s=""==l||null==l?"FlowDirNotSetArrow":"StartNode to EndNode"==l||"EndNode to StartNode"==l?"FlowDirSetArrow":"FlowDirSetBiDirectional";var d=Math.atan((n-e)/(r-t)),g=(parseFloat(t)+parseFloat(r))/2,u=(parseFloat(e)+parseFloat(n))/2;if(Math.abs(r-t)<minTolerance&&Math.abs(n-e)<minTolerance){let c=document.createElementNS("http://www.w3.org/2000/svg","line");c.setAttribute("x1",g+"mm"),c.setAttribute("y1",u+"mm"),c.setAttribute("x2",g+"mm"),c.setAttribute("y2",u+"mm"),c.setAttribute("class",s),c.setAttribute("id","fd1_"+a),o.appendChild(c);let m=document.createElementNS("http://www.w3.org/2000/svg","line");m.setAttribute("x1",g+"mm"),m.setAttribute("y1",u+"mm"),m.setAttribute("x2",g+"mm"),m.setAttribute("y2",u+"mm"),m.setAttribute("class",s),m.setAttribute("id","fd2_"+a),o.appendChild(m)}else{var h,b,A=g+largo*Math.sin(d),E=u-largo*Math.cos(d);t<=r?(h=g+2*largo*Math.cos(d),b=u+2*largo*Math.sin(d)):(h=g-2*largo*Math.cos(d),b=u-2*largo*Math.sin(d));let p=document.createElementNS("http://www.w3.org/2000/svg","line");p.setAttribute("x1",g+"mm"),p.setAttribute("y1",u+"mm"),p.setAttribute("x2",A+"mm"),p.setAttribute("y2",E+"mm"),p.setAttribute("class",s),p.setAttribute("id","fd1_"+a),o.appendChild(p);let x=document.createElementNS("http://www.w3.org/2000/svg","line");x.setAttribute("x1",A+"mm"),x.setAttribute("y1",E+"mm"),x.setAttribute("x2",h+"mm"),x.setAttribute("y2",b+"mm"),x.setAttribute("class",s),x.setAttribute("id","fd2_"+a),o.appendChild(x)}}function PaintEdge(t){if(t.getElementsByTagName("Data"),"OPC Pairing"!=t.getAttribute("Type")){var e="",r="";if("EndNode to StartNode"==t.getAttribute("FlowDir")?(null!=t.getAttribute("StartNode")&&(r=xmlDoc.querySelector('[*|id="'+t.getAttribute("StartNode")+'"]')),null!=t.getAttribute("EndNode")&&(e=xmlDoc.querySelector('[*|id="'+t.getAttribute("EndNode")+'"]'))):(null!=t.getAttribute("StartNode")&&(e=xmlDoc.querySelector('[*|id="'+t.getAttribute("StartNode")+'"]')),null!=t.getAttribute("EndNode")&&(r=xmlDoc.querySelector('[*|id="'+t.getAttribute("EndNode")+'"]'))),null!=e&&null!=r){var n=e.getAttribute("cx"),l=e.getAttribute("cy"),a=r.getAttribute("cx"),o=r.getAttribute("cy"),s=n.toString().replace(",","."),d=l.toString().replace(",","."),g=a.toString().replace(",","."),u=o.toString().replace(",",".");s*=factor,g*=factor,d=maxH-d*factor,u=maxH-u*factor;var c=t.parentNode.parentNode.parentNode,m=t.getAttribute("Type");let h=document.getElementById(m+"_"+c.getAttribute("Id")),b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",s+"mm"),b.setAttribute("y1",d+"mm"),b.setAttribute("x2",g+"mm"),b.setAttribute("y2",u+"mm"),b.setAttribute("id",t.getAttribute("id")),b.setAttribute("class",t.getAttribute("Type")),h.appendChild(b),document.getElementById(t.getAttribute("id")),FlowDirArrow(s,d,g,u,t.getAttribute("FlowDir"),t.getAttribute("id"),h)}}}function PaintNode(t){var e=t.getElementsByTagName("Data"),r=t.getAttribute("cx"),n=t.getAttribute("cy"),l=r.toString().replace(",","."),a=n.toString().replace(",",".");l*=factor,a=maxH-a*factor;var o=2,s="",d=e[0].getAttribute("Type");switch(d){case"Instrument":s="green";break;case"Nozzle":s="red";break;case"Equipment":s="brown",o=5;break;case"Piping Component":s="yellow";break;case"OPC":s="blue";break;case"Junction":s="orange";break;case"Equipment Component":s="brown";break;default:s="grey",d="Undefined node group"}var g=t.parentNode.parentNode.parentNode;let u=document.getElementById(d+"_"+g.getAttribute("Id")),c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("cx",l+"mm"),c.setAttribute("cy",a+"mm"),c.setAttribute("r",o+"mm"),c.setAttribute("stroke","black"),c.setAttribute("stroke-width","1"),c.setAttribute("fill",s),c.setAttribute("fill-opacity","50%"),c.setAttribute("id",t.getAttribute("id")),c.setAttribute("class","draggable"),u.appendChild(c)}function go(){extent=(xmlDoc=parser.parseFromString(xml,"text/xml")).getElementsByTagName("Extent");var t=xmlDoc.evaluate("//Drawings/@DrawingMatrixDimension",xmlDoc,null,XPathResult.STRING_TYPE,null).stringValue;maxW=xmlDoc.evaluate("//Drawings/@MaxDrawingWidth",xmlDoc,null,XPathResult.STRING_TYPE,null).stringValue*factor*t,maxH=xmlDoc.evaluate("//Drawings/@MaxDrawingHeight",xmlDoc,null,XPathResult.STRING_TYPE,null).stringValue*factor*t,document.getElementById("mysvg").setAttribute("width",maxW+"mm"),document.getElementById("mysvg").setAttribute("height",maxH+"mm");let e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("width",maxW+"mm"),e.setAttribute("height",maxH+"mm"),e.setAttribute("style","fill:none;stroke-width:6;stroke:rgb(55,55,255)"),document.getElementById("mysvg").appendChild(e);var r=xmlDoc.getElementsByTagName("Node");for(i=0;i<r.length;i++)PaintNode(r[i]);var n=xmlDoc.getElementsByTagName("Edge");for(i=0;i<n.length;i++)PaintEdge(n[i]);makeDraggable(),setupContextMenu(),document.addEventListener("keydown",KeyPressed,!1)}function KeyPressed(){"Escape"===event.key&&((todo=document.querySelectorAll("svg *")).forEach(t=>unhighlight(t.getAttribute("id"))),document.getElementById("floatingWindow").style.display="none")}function setupContextMenu(){contextMenu=document.getElementById("contextMenu"),modal=document.getElementById("modal"),propertiesTable=document.getElementById("propertiesTable"),document.addEventListener("click",()=>{contextMenu.classList.remove("show")});let t=document.getElementById("floatingWindow"),e=document.getElementById("windowHeader"),r=document.getElementById("closeButton");t.style.display="none";let n=0,l=0,a=!1;e.addEventListener("mousedown",r=>{a=!0,n=r.clientX-t.offsetLeft,l=r.clientY-t.offsetTop,e.style.cursor="grabbing"}),document.addEventListener("mousemove",e=>{a&&(t.style.left=`${e.clientX-n}px`,t.style.top=`${e.clientY-l}px`)}),document.addEventListener("mouseup",()=>{a=!1,e.style.cursor="grab"}),r.addEventListener("click",()=>{t.style.display="none"})}function showDownstreamPaths(){var t=document.getElementById("modal");t.classList.add("active"),setTimeout(()=>{selectedPaths=FindDownstreamPaths(currentElement.id),t.classList.remove("active"),populatePathsTable("Downstream paths")},250)}function showUpstreamPaths(){var t=document.getElementById("modal");t.classList.add("active"),setTimeout(()=>{selectedPaths=FindUpstreamPaths(currentElement.id),t.classList.remove("active"),populatePathsTable("Upstream paths")},250)}function equipmentIsolationPaths(){var t=document.getElementById("modal");t.classList.add("active"),setTimeout(()=>{selectedPaths=IsolateEquipment(currentElement.id),t.classList.remove("active"),populatePathsTable("Equipment isolation")},250)}function showProperties(){document.getElementById("floatingWindow").style.display="block";let t=currentElement.id,e=showMetadata(t);document.getElementById("windowTitle").innerHTML="Properties",propertiesTable.innerHTML="",e.forEach(t=>{let e=document.createElement("tr"),r=document.createElement("td"),n=document.createElement("td");r.textContent=t.name,r.style.textAlign="right",n.textContent=t.value,e.appendChild(r),e.appendChild(n),propertiesTable.appendChild(e)})}function closeModal(){modal.style.display="none"}function unhighlight(t){(elmt=document.getElementById(t))?(elmtClass=elmt.className.baseVal+"").includes("_highlighted")&&(elmtClass=elmtClass.substring(0,elmt.classList[0].length-12),elmt.setAttribute("class",elmtClass)):(console.log('Highlight - Element not found for element ID="'+t+'"'),console.clear())}function highlight(t){(elmt=document.getElementById(t))?(elmtClass=elmt.className.baseVal+"").includes("_highlighted")||elmt.setAttribute("class",elmtClass+"_highlighted"):(console.log('Highlight - Element not found for element ID="'+t+'"'),console.clear())}function setOpacity(t,e){document.getElementById(t).setAttribute("opacity",e)}function xPathSelect(t){for(var e=xmlDoc.evaluate(t,xmlDoc,null,XPathResult.ANY_TYPE,null),r=e.iterateNext(),n=[],l=0;r;){n[l]=r.attributes[0].nodeValue,l++;var r=e.iterateNext()}n.forEach(highlight)}function evaluateCriteria(t,e){return query="//"+(itemClass=xmlDoc.getElementById(t).localName)+"[@id='"+t+"']"+e,(matches=xmlDoc.evaluate(query,xmlDoc,null,XPathResult.BOOLEAN_TYPE,null)).booleanValue}function _findPaths(t,e,r,n,l,a,o=[]){null==a&&(a=defaultPathLengthLimit);var s=o.map(t=>t);if(s.push(t),s.length>a)return lengthExcededCount++,[];if(t===e)return[s];let d=[];var g=xmlDoc.querySelectorAll('Edge[StartNode="'+t+'"], Edge[EndNode="'+t+'"]');for(let u=0;u<g.length;u++)if(evaluateCriteria(g[u].getAttribute("id"),l)){var c="";if(evaluateCriteria(c=r?"StartNode to EndNode"==g[u].getAttribute("FlowDir")||""==g[u].getAttribute("FlowDir")?g[u].getAttribute("EndNode"):g[u].getAttribute("StartNode"):g[u].getAttribute("StartNode")===t?g[u].getAttribute("EndNode"):g[u].getAttribute("StartNode"),n)&&!s.includes(c)){let m=_findPaths(c,e,r,n,l,a,s);for(let h=0;h<m.length;h++)d.push(m[h])}}return d}function FindPaths(t,e,r,n,l,a,o=[]){return result=_findPaths(t,e,r,n,l,a,o).sort((t,e)=>t.length-e.length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+a+") was exceeded."),lengthExcededCount=0),result}function _findStreamPaths(t,e,r,n,l,a=[],o=[]){var l=defaultPathLengthLimit;null==l&&(l=defaultPathLengthLimit);var s=a.map(t=>t),d=o.map(t=>t);if(s.push(t),s.length>l)return lengthExcededCount++,[];if(""==e&&evaluateCriteria(t,r))return[s];let g=[];var u=0,c=xmlDoc.querySelectorAll('Edge[StartNode="'+t+'"], Edge[EndNode="'+t+'"]');for(let m=0;m<c.length;m++)if(!d.includes(c[m].getAttribute("id"))&&(d.push(c[m].getAttribute("id")),evaluateCriteria(c[m].getAttribute("id"),n))){var h="";if("Downstream"==e&&(t==c[m].getAttribute("StartNode")&&(h="StartNode to EndNode"==c[m].getAttribute("FlowDir")||""==c[m].getAttribute("FlowDir")?c[m].getAttribute("EndNode"):""),t==c[m].getAttribute("EndNode")&&(h="EndNode to StartNode"==c[m].getAttribute("FlowDir")?c[m].getAttribute("StartNode"):"")),"Upstream"==e&&(t==c[m].getAttribute("StartNode")&&(h="EndNode to StartNode"==c[m].getAttribute("FlowDir")?c[m].getAttribute("EndNode"):""),t==c[m].getAttribute("EndNode")&&(h="StartNode to EndNode"==c[m].getAttribute("FlowDir")||""==c[m].getAttribute("FlowDir")?c[m].getAttribute("StartNode"):"")),""==e&&(h=t==c[m].getAttribute("StartNode")?c[m].getAttribute("EndNode"):c[m].getAttribute("StartNode")),""!=h&&!s.includes(h)){u++;let b=_findStreamPaths(h,e,r,n,l,s,d);for(let A=0;A<b.length;A++)g.push(b[A])}}return 0==u?[s]:g}function FindDownstreamPaths(t){var e=defaultPathLengthLimit;return(result=_findStreamPaths(t,"Downstream",downstreamNodeFilter,downstreamEdgeFilter).sort((t,e)=>t.length-e.length)).length>0&&console.log("FindDownstreamPaths : Max path lengh = "+result[result.length-1].length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+e+") was exceeded."),lengthExcededCount=0),result}function FindUpstreamPaths(t){var e=defaultPathLengthLimit;return(result=_findStreamPaths(t,"Upstream",upstreamNodeFilter,upwnstreamEdgeFilter).sort((t,e)=>t.length-e.length)).length>0&&console.log("FindUpstreamPaths : Max path lengh = "+result[result.length-1].length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+e+") was exceeded."),lengthExcededCount=0),result.forEach(highlightPath),result}function IsolateEquipment(t){var e=defaultPathLengthLimit;return(result=_findStreamPaths(t,"",isolateNodeFilter,isolateEdgeFilter).sort((t,e)=>t.length-e.length)).length>0&&console.log("IsolateEquipment : Max path lengh = "+result[result.length-1].length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+e+") was exceeded."),lengthExcededCount=0),result.forEach(highlightPath),result}function highlightPath(t=[]){for(t.map(highlight),i=1;i<t.length;i++)highlight(xmlDoc.evaluate("//Edge[(@StartNode='"+t[i-1]+"' and @EndNode='"+t[i]+"') or (@StartNode='"+t[i]+"' and @EndNode='"+t[i-1]+"')]",xmlDoc,null,XPathResult.ANY_TYPE,null).iterateNext().attributes[0].value)}function populatePathsTable(t){var e=selectedPaths;propertiesTable.innerHTML="",document.getElementById("windowTitle").innerHTML=t,(fwindow=document.getElementById("floatingWindow")).style.display="block";var r='<table><tr><td><input type="checkbox" id="path_all" onchange="checkboxChanged(\'path_all\')" checked>&nbsp;'+selectedPaths.length+" paths found</td></tr></table>";e.length,r+="<table><tr valign='top'>";var n=0;e.forEach(t=>{0==n?r+="<td><table>":n%15==0&&(r+="</table></td><td><table>"),r+='<tr><td><input type="checkbox" id="path_'+n+'" onchange="checkboxChanged(\'path_'+n+"')\" checked></td>",r+="<td>Path "+(n+1)+": "+e[n].length+" nodes</td></tr>",highlightPath(t),n++}),r+="</table></td></tr></table>",propertiesTable.innerHTML=r}function checkboxChanged(t){var e=selectedPaths;cb=document.getElementById(t),console.log(cb.checked);var r=0;if("path_all"==t)for(r=0;r<e.length;r++)document.getElementById("path_"+r).checked=cb.checked;for((todo=document.querySelectorAll("svg *")).forEach(t=>unhighlight(t.getAttribute("id"))),r=0;r<e.length;r++)document.getElementById("path_"+r).checked&&highlightPath(e[r])}
