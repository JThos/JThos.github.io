var maxH,maxW,xmlDoc,drawing,selectedElement,offset,transform,patterns,patternsDoc,xml,selectedPaths,corrector=3.775,minTolerance=10,largo=3,factor=750,parser=new DOMParser,selectSet=[],highlightedItem="",defaultPathLengthLimit=250,lengthExcededCount=0;let currentElement=null;var contextMenu=null,modal=null,propertiesTable=null,svg=document.getElementById("mysvg");let startX,startY,viewBox=[800,-0,1800,1800],isPanning=!1;var isolatedItemId="",downstreamNodeFilter="",downstreamEdgeFilter="[@Type='Piping' or @Type='DirectConnection']",upstreamNodeFilter="",upwnstreamEdgeFilter="[@Type='Piping' or @Type='DirectConnection']",isolateNodeFilter="/Data[(contains(@Subtype,'valve') and not(contains(@Subtype,'Check')) and not(contains(@Subtype,'check'))) or @Type='Nozzle']",isolateEdgeFilter="[@Type='Piping' or @Type='DirectConnection']",listOfChildNozzles="";function makeDraggable(){(svg=document.getElementById("mysvg")).addEventListener("contextmenu",rightClick,!1),svg.addEventListener("mousedown",startDrag,!1),svg.addEventListener("mousemove",drag,!1),svg.addEventListener("mouseup",endDrag,!1),svg.addEventListener("wheel",(t=>{t.preventDefault();let e=t.deltaY<0?1/1.1:1.1,n=t.clientX/window.innerWidth*viewBox[2]+viewBox[0],l=t.clientY/window.innerHeight*viewBox[3]+viewBox[1];viewBox[2]*=e,viewBox[3]*=e,viewBox[0]=n-(n-viewBox[0])*e,viewBox[1]=l-(l-viewBox[1])*e,svg.setAttribute("viewBox",viewBox.join(" "))}))}function showMetadata(t){var e=[],n=xmlDoc.getElementById(t);if(null!=n){console.clear();var l=0;for(e.push({name:"Graph element",value:n.nodeName}),l=0;l<n.attributes.length;l++)e.push({name:n.attributes[l].nodeName,value:n.attributes[l].nodeValue.replaceAll("\\","\\\\")});var r=n.childNodes[0];for(l=0;l<r.attributes.length;l++){var i=r.attributes[l].nodeValue.replaceAll("\\","\\\\");i=i.replace('"','\\"'),e.push({name:r.attributes[l].nodeName,value:i})}}return e}function rightClick(t){t.preventDefault(),highlight(highlightedItem=t.target.getAttribute("id")),currentElement=t.target;const e=t.pageX,n=t.pageY,l=contextMenu.offsetWidth,r=contextMenu.offsetHeight;contextMenu.style.left=(e+l>window.innerWidth?window.innerWidth-l:e)+"px",contextMenu.style.top=(n+r>window.innerHeight?window.innerHeight-r:n)+"px",contextMenu.classList.add("show")}function startDrag(t){0==t.button?"mysvg"==t.target.getAttribute("id")?(isPanning=!0,startX=event.clientX,startY=event.clientY,svg.style.cursor="grabbing"):(highlightedItem&&(highlight(highlightedItem),highlightedItem=""),highlight(highlightedItem=t.target.getAttribute("id")),selectSet.includes(highlightedItem)||selectSet.push(highlightedItem),(t.target.classList.contains("draggable")||t.target.classList.contains("draggable_highlighted"))&&(selectedElement=t.target)):t.button}function drag(t){if(0==t.button)if("mysvg"==t.target.getAttribute("id")){if(!isPanning)return;let t=(event.clientX-startX)*(viewBox[2]/window.innerWidth),e=(event.clientY-startY)*(viewBox[3]/window.innerHeight);viewBox[0]-=t,viewBox[1]-=e,svg.setAttribute("viewBox",viewBox.join(" ")),startX=event.clientX,startY=event.clientY}else if(selectedElement&&"info"!=selectedElement){var e=oMousePosSVG(t);selectedElement.setAttribute("cx",parseInt(e.x)/corrector+"mm"),selectedElement.setAttribute("cy",parseInt(e.y)/corrector+"mm")}}function endDrag(t){if("mysvg"==t.target.getAttribute("id"))isPanning=!1,(D=document.getElementById("mysvg")).style.cursor="grab";else if(selectedElement)if(0==t.button){var e=oMousePosSVG(t);selectedElement.setAttribute("cx",parseInt(e.x)/corrector+"mm"),selectedElement.setAttribute("cy",parseInt(e.y)/corrector+"mm");var n=null,l=null,r=null,a=null,o=xmlDoc.getElementsByTagName("Edge");for(i=0;i<o.length;i++){n=null,l=null,r=null,a=null;var s="";s="EndNode to StartNode"==o[i].getAttribute("FlowDir")?o[i].getAttribute("EndNode"):o[i].getAttribute("StartNode");var d=document.getElementById(o[i].id);s==selectedElement.id&&"OPC Pairing"!=o[i].childNodes[0].getAttribute("Type")&&null!=d&&(d.setAttribute("x1",selectedElement.getAttribute("cx")),d.setAttribute("y1",selectedElement.getAttribute("cy")),n=d.getAttribute("x1"),l=d.getAttribute("y1"),r=d.getAttribute("x2"),a=d.getAttribute("y2"));if(("EndNode to StartNode"==o[i].getAttribute("FlowDir")?o[i].getAttribute("StartNode"):o[i].getAttribute("EndNode"))==selectedElement.id&&"OPC Pairing"!=o[i].childNodes[0].getAttribute("Type")&&null!=d&&(d.setAttribute("x2",selectedElement.getAttribute("cx")),d.setAttribute("y2",selectedElement.getAttribute("cy")),n=d.getAttribute("x1"),l=d.getAttribute("y1"),r=d.getAttribute("x2"),a=d.getAttribute("y2")),null!=n&&null!=l&&null!=r&&null!=a){var u=parseFloat(n.replace("mm","")),c=parseFloat(l.replace("mm","")),m=parseFloat(r.replace("mm","")),g=parseFloat(a.replace("mm","")),h=(g-c)/(m-u),p=Math.atan(h),b=(parseFloat(u)+parseFloat(m))/2,E=(parseFloat(c)+parseFloat(g))/2,x=m-u,y=g-c,A=document.getElementById("fd1_"+d.getAttribute("id")),v=document.getElementById("fd2_"+d.getAttribute("id"));if(Math.abs(x)<minTolerance&&Math.abs(y)<minTolerance)A.setAttribute("x1",b+"mm"),A.setAttribute("y1",E+"mm"),A.setAttribute("x2",b+"mm"),A.setAttribute("y2",E+"mm"),v.setAttribute("x1",b+"mm"),v.setAttribute("y1",E+"mm"),v.setAttribute("x2",b+"mm"),v.setAttribute("y2",E+"mm");else{var f,w,N=b+largo*Math.sin(p),P=E-largo*Math.cos(p);u<=m?(f=b+2*largo*Math.cos(p),w=E+2*largo*Math.sin(p)):(f=b-2*largo*Math.cos(p),w=E-2*largo*Math.sin(p)),A.setAttribute("x1",b+"mm"),A.setAttribute("y1",E+"mm"),A.setAttribute("x2",N+"mm"),A.setAttribute("y2",P+"mm"),v.setAttribute("x1",N+"mm"),v.setAttribute("y1",P+"mm"),v.setAttribute("x2",f+"mm"),v.setAttribute("y2",w+"mm")}}}selectedElement=!1}else if(2==t.button){var D=document.getElementById("mysvg"),S=document.getElementById("info");null!=S&&D.removeChild(S),selectedElement=!1}}function GetElementsByAttribute(t,e,n){return Array.prototype.slice.call(xmlDoc.getElementsByTagName(t),0).where((function(t){return t.getAttribute(e)==n}))}function oMousePosSVG(t){var e=mysvg.createSVGPoint();e.x=t.clientX,e.y=t.clientY;var n=mysvg.getScreenCTM().inverse();return e.matrixTransform(n)}function FlowDirArrow(t,e,n,l,r,i,a){var o="";o=""==r||null==r?"FlowDirNotSetArrow":"StartNode to EndNode"==r||"EndNode to StartNode"==r?"FlowDirSetArrow":"FlowDirSetBiDirectional";var s=(l-e)/(n-t),d=Math.atan(s),u=(parseFloat(t)+parseFloat(n))/2,c=(parseFloat(e)+parseFloat(l))/2,m=n-t,g=l-e;if(Math.abs(m)<minTolerance&&Math.abs(g)<minTolerance){let t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",u+"mm"),t.setAttribute("y1",c+"mm"),t.setAttribute("x2",u+"mm"),t.setAttribute("y2",c+"mm"),t.setAttribute("class",o),t.setAttribute("id","fd1_"+i),a.appendChild(t);let e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",u+"mm"),e.setAttribute("y1",c+"mm"),e.setAttribute("x2",u+"mm"),e.setAttribute("y2",c+"mm"),e.setAttribute("class",o),e.setAttribute("id","fd2_"+i),a.appendChild(e)}else{var h,p,b=u+largo*Math.sin(d),E=c-largo*Math.cos(d);t<=n?(h=u+2*largo*Math.cos(d),p=c+2*largo*Math.sin(d)):(h=u-2*largo*Math.cos(d),p=c-2*largo*Math.sin(d));let e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",u+"mm"),e.setAttribute("y1",c+"mm"),e.setAttribute("x2",b+"mm"),e.setAttribute("y2",E+"mm"),e.setAttribute("class",o),e.setAttribute("id","fd1_"+i),a.appendChild(e);let l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",b+"mm"),l.setAttribute("y1",E+"mm"),l.setAttribute("x2",h+"mm"),l.setAttribute("y2",p+"mm"),l.setAttribute("class",o),l.setAttribute("id","fd2_"+i),a.appendChild(l)}}function PaintEdge(t){t.getElementsByTagName("Data");if("OPC Pairing"!=t.getAttribute("Type")){var e="",n="";if("EndNode to StartNode"==t.getAttribute("FlowDir")?(null!=t.getAttribute("StartNode")&&(n=xmlDoc.querySelector('[*|id="'+t.getAttribute("StartNode")+'"]')),null!=t.getAttribute("EndNode")&&(e=xmlDoc.querySelector('[*|id="'+t.getAttribute("EndNode")+'"]'))):(null!=t.getAttribute("StartNode")&&(e=xmlDoc.querySelector('[*|id="'+t.getAttribute("StartNode")+'"]')),null!=t.getAttribute("EndNode")&&(n=xmlDoc.querySelector('[*|id="'+t.getAttribute("EndNode")+'"]'))),null!=e&&null!=n){var l=e.getAttribute("cx"),r=e.getAttribute("cy"),i=n.getAttribute("cx"),a=n.getAttribute("cy"),o=l.toString().replace(",","."),s=r.toString().replace(",","."),d=i.toString().replace(",","."),u=a.toString().replace(",",".");o*=factor,d*=factor,s=maxH-s*factor,u=maxH-u*factor;var c=t.parentNode.parentNode.parentNode,m=t.getAttribute("Type");let g=document.getElementById(m+"_"+c.getAttribute("Id")),h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",o+"mm"),h.setAttribute("y1",s+"mm"),h.setAttribute("x2",d+"mm"),h.setAttribute("y2",u+"mm"),h.setAttribute("id",t.getAttribute("id")),h.setAttribute("class",t.getAttribute("Type")),g.appendChild(h);document.getElementById(t.getAttribute("id"));FlowDirArrow(o,s,d,u,t.getAttribute("FlowDir"),t.getAttribute("id"),g)}}}function PaintNode(t){var e=t.getElementsByTagName("Data"),n=t.getAttribute("cx"),l=t.getAttribute("cy"),r=n.toString().replace(",","."),i=l.toString().replace(",",".");r*=factor,i=maxH-i*factor;var a=2,o="",s=e[0].getAttribute("Type");switch(s){case"Instrument":o="green";break;case"Nozzle":o="red";break;case"Equipment":o="brown",a=5;break;case"Piping Component":o="yellow";break;case"OPC":o="blue";break;case"Junction":o="orange";break;case"Equipment Component":o="brown";break;default:o="grey",s="Undefined node group"}var d=t.parentNode.parentNode.parentNode;let u=document.getElementById(s+"_"+d.getAttribute("Id")),c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("cx",r+"mm"),c.setAttribute("cy",i+"mm"),c.setAttribute("r",a+"mm"),c.setAttribute("stroke","black"),c.setAttribute("stroke-width","1"),c.setAttribute("fill",o),c.setAttribute("fill-opacity","50%"),c.setAttribute("id",t.getAttribute("id")),c.setAttribute("class","draggable"),u.appendChild(c)}function go(){xmlDoc=parser.parseFromString(xml,"text/xml"),extent=xmlDoc.getElementsByTagName("Extent");var t=xmlDoc.evaluate("//Drawings/@DrawingMatrixDimension",xmlDoc,null,XPathResult.STRING_TYPE,null).stringValue;maxW=xmlDoc.evaluate("//Drawings/@MaxDrawingWidth",xmlDoc,null,XPathResult.STRING_TYPE,null).stringValue*factor*t,maxH=xmlDoc.evaluate("//Drawings/@MaxDrawingHeight",xmlDoc,null,XPathResult.STRING_TYPE,null).stringValue*factor*t,document.getElementById("mysvg").setAttribute("width",maxW+"mm"),document.getElementById("mysvg").setAttribute("height",maxH+"mm");let e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("width",maxW+"mm"),e.setAttribute("height",maxH+"mm"),e.setAttribute("style","fill:none;stroke-width:6;stroke:rgb(55,55,255)"),document.getElementById("mysvg").appendChild(e);var n=xmlDoc.getElementsByTagName("Node");for(i=0;i<n.length;i++)PaintNode(n[i]);var l=xmlDoc.getElementsByTagName("Edge");for(i=0;i<l.length;i++)PaintEdge(l[i]);makeDraggable(),setupContextMenu(),document.addEventListener("keydown",KeyPressed,!1);const r=document.createElement("button");r.innerText="Chat P&ID",r.style.position="fixed",r.style.bottom="20px",r.style.right="20px",r.style.padding="10px 20px",r.style.background="#007bff",r.style.color="white",r.style.border="none",r.style.borderRadius="5px",r.style.cursor="pointer",document.body.appendChild(r);const a=document.createElement("div");a.style.position="fixed",a.style.bottom="60px",a.style.right="20px",a.style.width="300px",a.style.height="400px",a.style.background="white",a.style.border="1px solid #ccc",a.style.borderRadius="10px",a.style.display="none",a.style.flexDirection="column",a.style.padding="10px",a.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.1)",document.body.appendChild(a);const o=document.createElement("div");o.style.flex="1",o.style.overflowY="auto",o.style.marginBottom="10px",a.appendChild(o);const s=document.createElement("input");s.type="text",s.style.width="calc(100% - 20px)",s.style.padding="5px",a.appendChild(s);const d=document.createElement("button");d.innerText="Enviar",d.style.width="100%",d.style.marginTop="5px",a.appendChild(d),r.addEventListener("click",(()=>{a.style.display="none"===a.style.display?"flex":"none"})),d.addEventListener("click",(async()=>{const t=s.value;if(!t)return;const e=document.createElement("div");e.innerText=`Tú: ${t}`,o.appendChild(e);const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer 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"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:"Tu pregunta aquí"}],temperature:.7})}),l=await n.json();console.log("Respuesta de la API:",l);const r=l.choices[0].message.content,i=document.createElement("div");i.innerText=`Bot: ${r}`,o.appendChild(i);findElementsInXML(r).forEach((t=>{highlight(t)})),s.value=""}))}function GetPattern(){var t=parser.parseFromString("<Pattern Name='give me a name'></Pattern>","text/xml");selectSet.forEach((function(e){var n=xmlDoc.evaluate("//*[@id='"+e+"']",xmlDoc,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null),l=parser.parseFromString(n.singleNodeValue.outerHTML,"text/xml").documentElement;t.documentElement.appendChild(l)}));for(var e={},n=t.evaluate("//Node",t,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),l=0;l<n.snapshotLength;l++){var r=(a=n.snapshotItem(l)).getAttribute("id"),i="N"+l.toString().padStart(2,0);e[r]=i,a.setAttribute("id",i),0==l&&a.setAttribute("Reference","yes"),a.removeAttribute("cx"),a.removeAttribute("cy")}for(n=t.evaluate("//Edge",t,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),l=0;l<n.snapshotLength;l++){var a;r=(a=n.snapshotItem(l)).getAttribute("id"),i="E"+l.toString().padStart(2,0);e[r]="E"+l.toString().padStart(2,0),a.setAttribute("id",i);var o=a.getAttribute("StartNode"),s=a.getAttribute("EndNode"),d=e[o]??"",u=e[s]??"";a.setAttribute("StartNode",d),a.setAttribute("EndNode",u),a.removeAttribute("RunID")}window.navigator.clipboard.writeText(t.documentElement.outerHTML),alert("Pattern was successfully copied to Clipboard")}function KeyPressed(){"Escape"===event.key&&(todo=document.querySelectorAll("svg *"),todo.forEach((t=>unhighlight(t.getAttribute("id")))),document.getElementById("floatingWindow").style.display="none",selectSet=[])}function setupContextMenu(){contextMenu=document.getElementById("contextMenu"),modal=document.getElementById("modal"),propertiesTable=document.getElementById("propertiesTable"),document.addEventListener("click",(()=>{contextMenu.classList.remove("show")}));let t=document.querySelector("#contextMenu ul"),e=document.createElement("li");e.textContent="Isolate Equipment",e.onclick=equipmentIsolationPaths,t.appendChild(e),e=document.createElement("li"),e.textContent="Downstream paths",e.onclick=showDownstreamPaths,t.appendChild(e),e=document.createElement("li"),e.textContent="Upstream paths",e.onclick=showUpstreamPaths,t.appendChild(e),e=document.createElement("li"),e.textContent="Properties",e.onclick=showProperties,t.appendChild(e),e=document.createElement("li"),e.textContent="Copy as pattern",e.onclick=GetPattern,t.appendChild(e);const n=document.getElementById("floatingWindow"),l=document.getElementById("windowHeader"),r=document.getElementById("closeButton");n.style.display="none";let i=0,a=0,o=!1;l.addEventListener("mousedown",(t=>{o=!0,i=t.clientX-n.offsetLeft,a=t.clientY-n.offsetTop,l.style.cursor="grabbing"})),document.addEventListener("mousemove",(t=>{o&&(n.style.left=t.clientX-i+"px",n.style.top=t.clientY-a+"px")})),document.addEventListener("mouseup",(()=>{o=!1,l.style.cursor="grab"})),r.addEventListener("click",(()=>{n.style.display="none"}))}function showDownstreamPaths(){var t=document.getElementById("modal");t.classList.add("active"),setTimeout((()=>{selectedPaths=FindDownstreamPaths(currentElement.id),t.classList.remove("active"),populatePathsTable("Downstream paths")}),250)}function showUpstreamPaths(){var t=document.getElementById("modal");t.classList.add("active"),setTimeout((()=>{selectedPaths=FindUpstreamPaths(currentElement.id),t.classList.remove("active"),populatePathsTable("Upstream paths")}),250)}function equipmentIsolationPaths(){var t=document.getElementById("modal");t.classList.add("active"),setTimeout((()=>{selectedPaths=IsolateEquipment(currentElement.id),t.classList.remove("active"),populatePathsTable("Equipment isolation")}),250)}function showProperties(){document.getElementById("floatingWindow").style.display="block";const t=showMetadata(currentElement.id);document.getElementById("windowTitle").innerHTML="Properties",propertiesTable.innerHTML="",t.forEach((t=>{const e=document.createElement("tr"),n=document.createElement("td"),l=document.createElement("td");n.textContent=t.name,n.style.textAlign="right",l.textContent=t.value,e.appendChild(n),e.appendChild(l),propertiesTable.appendChild(e)}))}function closeModal(){modal.style.display="none"}function unhighlight(t){elmt=document.getElementById(t),elmt?(elmtClass=elmt.className.baseVal+"",elmtClass.includes("_highlighted")&&(elmtClass=elmtClass.substring(0,elmt.classList[0].length-12),elmt.setAttribute("class",elmtClass))):(console.log('Highlight - Element not found for element ID="'+t+'"'),console.clear())}function highlight(t){elmt=document.getElementById(t),elmt?(elmtClass=elmt.className.baseVal+"",elmtClass.includes("_highlighted")||elmt.setAttribute("class",elmtClass+"_highlighted")):(console.log('Highlight - Element not found for element ID="'+t+'"'),console.clear())}function setOpacity(t,e){document.getElementById(t).setAttribute("opacity",e)}function xPathSelect(t){for(var e=xmlDoc.evaluate(t,xmlDoc,null,XPathResult.ANY_TYPE,null),n=e.iterateNext(),l=[],r=0;n;){l[r]=n.attributes[0].nodeValue,r++;n=e.iterateNext()}l.forEach(highlight)}function evaluateCriteria(t,e){var n=xmlDoc.getElementById(t);return itemClass=n.localName,query="//"+itemClass+"[@id='"+t+"']"+e,matches=xmlDoc.evaluate(query,xmlDoc,null,XPathResult.BOOLEAN_TYPE,null),matches.booleanValue}function _findPaths(t,e,n,l,r,i,a=[]){null==i&&(i=defaultPathLengthLimit);var o=a.map((t=>t));if(o.push(t),o.length>i)return lengthExcededCount++,[];if(t===e)return[o];const s=[];var d=xmlDoc.querySelectorAll('Edge[StartNode="'+t+'"], Edge[EndNode="'+t+'"]');for(let a=0;a<d.length;a++)if(evaluateCriteria(d[a].getAttribute("id"),r)){var u="";if(evaluateCriteria(u=n?"StartNode to EndNode"==d[a].getAttribute("FlowDir")||""==d[a].getAttribute("FlowDir")?d[a].getAttribute("EndNode"):d[a].getAttribute("StartNode"):d[a].getAttribute("StartNode")===t?d[a].getAttribute("EndNode"):d[a].getAttribute("StartNode"),l)&&!o.includes(u)){const t=_findPaths(u,e,n,l,r,i,o);for(let e=0;e<t.length;e++)s.push(t[e])}}return s}function FindPaths(t,e,n,l,r,i,a=[]){return result=_findPaths(t,e,n,l,r,i,a).sort(((t,e)=>t.length-e.length)),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+i+") was exceeded."),lengthExcededCount=0),result}function _findStreamPaths(t,e,n,l,r,i=[],a=[]){null==(r=defaultPathLengthLimit)&&(r=defaultPathLengthLimit);var o=i.map((t=>t)),s=a.map((t=>t));if(o.push(t),o.length>r)return lengthExcededCount++,[];if(""==e&&!listOfChildNozzles.includes(t)&&evaluateCriteria(t,n))return[o];const d=[];var u=0,c=xmlDoc.querySelectorAll('Edge[StartNode="'+t+'"], Edge[EndNode="'+t+'"]');for(let i=0;i<c.length;i++)if(!s.includes(c[i].getAttribute("id"))&&(s.push(c[i].getAttribute("id")),evaluateCriteria(c[i].getAttribute("id"),l))){var m="";if("Downstream"==e&&(t==c[i].getAttribute("StartNode")&&(m="StartNode to EndNode"==c[i].getAttribute("FlowDir")||""==c[i].getAttribute("FlowDir")?c[i].getAttribute("EndNode"):""),t==c[i].getAttribute("EndNode")&&(m="EndNode to StartNode"==c[i].getAttribute("FlowDir")?c[i].getAttribute("StartNode"):"")),"Upstream"==e&&(t==c[i].getAttribute("StartNode")&&(m="EndNode to StartNode"==c[i].getAttribute("FlowDir")?c[i].getAttribute("EndNode"):""),t==c[i].getAttribute("EndNode")&&(m="StartNode to EndNode"==c[i].getAttribute("FlowDir")||""==c[i].getAttribute("FlowDir")?c[i].getAttribute("StartNode"):"")),""==e&&(m=t==c[i].getAttribute("StartNode")?c[i].getAttribute("EndNode"):c[i].getAttribute("StartNode")),""!=m&&!o.includes(m)){u++;const t=_findStreamPaths(m,e,n,l,r,o,s);for(let e=0;e<t.length;e++)d.push(t[e])}}return 0==u?[o]:d}function FindDownstreamPaths(t){var e=defaultPathLengthLimit;return result=_findStreamPaths(t,"Downstream",downstreamNodeFilter,downstreamEdgeFilter).sort(((t,e)=>t.length-e.length)),result.length>0&&console.log("FindDownstreamPaths : Max path lengh = "+result[result.length-1].length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+e+") was exceeded."),lengthExcededCount=0),result}function FindUpstreamPaths(t){var e=defaultPathLengthLimit;return result=_findStreamPaths(t,"Upstream",upstreamNodeFilter,upwnstreamEdgeFilter).sort(((t,e)=>t.length-e.length)),result.length>0&&console.log("FindUpstreamPaths : Max path lengh = "+result[result.length-1].length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+e+") was exceeded."),lengthExcededCount=0),result.forEach(highlightPath),result}function IsolateEquipment(t){if(itemToIsolate=xmlDoc.getElementById(t),"Equipment"==itemToIsolate.children[0].getAttribute("Type")){listOfChildNozzles="";for(var e=xmlDoc.evaluate("//Node[@id=//Edge[@Type='DirectConnection' and @EndNode='"+t+"']/@StartNode]/@id",xmlDoc,null,XPathResult.ANY_TYPE,null);noz1=e.iterateNext();)listOfChildNozzles+=noz1.value+",";for(var n=xmlDoc.evaluate("//Node[@id=//Edge[@Type='DirectConnection' and @StartNode='"+t+"']/@EndNode]/@id",xmlDoc,null,XPathResult.ANY_TYPE,null);noz2=n.iterateNext();)listOfChildNozzles+=noz2.value+",";isolatedItemId=t;var l=defaultPathLengthLimit;return result=_findStreamPaths(t,"",isolateNodeFilter,isolateEdgeFilter).sort(((t,e)=>t.length-e.length)),result.length>0&&console.log("IsolateEquipment : Max path lengh = "+result[result.length-1].length),lengthExcededCount>0&&(console.log("WARNING: "+lengthExcededCount+" search branches where discarded, because prune length ("+l+") was exceeded."),lengthExcededCount=0),result.forEach(highlightPath),isolatedItemId="",result}}function highlightPath(t=[]){for(t.map(highlight),i=1;i<t.length;i++){highlight(xmlDoc.evaluate("//Edge[(@StartNode='"+t[i-1]+"' and @EndNode='"+t[i]+"') or (@StartNode='"+t[i]+"' and @EndNode='"+t[i-1]+"')]",xmlDoc,null,XPathResult.ANY_TYPE,null).iterateNext().attributes[0].value)}}function copyPathToClipboard(t=[]){var e="[";for(i=0;i<t.length;i++){var n=xmlDoc.getElementById(t[i]),l=n.children[0].getAttribute("ItemTag");null==l&&(l=n.id),e+=l+","}e=e.slice(0,-1),e+="]",window.navigator.clipboard.writeText(e)}function populatePathsTable(t){var e=selectedPaths;propertiesTable.innerHTML="",document.getElementById("windowTitle").innerHTML=t,fwindow=document.getElementById("floatingWindow"),fwindow.style.display="block";var n='<table><tr><td><input type="checkbox" id="path_all" onchange="checkboxChanged(\'path_all\')" checked>&nbsp;'+selectedPaths.length+" paths found</td></tr></table>";Math.ceil(e.length/15);n+="<table><tr valign='top'>";var l=0;e.forEach((t=>{textedPath=t.map((function(t){return"'"+t+"'"})),0==l?n+="<td><table>":l%15==0&&(n+="</table></td><td><table>"),n+='<tr><td><input type="checkbox" id="path_'+l+'" onchange="checkboxChanged(\'path_'+l+"')\" checked></td>",n+='<td><button class="copy-btn" id="cc_'+l+'" onclick="copyPathToClipboard(['+textedPath+']);"><img src="https://jthos.github.io/copy.jpg" alt="Copy path to clipboard" class="icono"></button></td>',n+="<td>Path "+(l+1)+": "+e[l].length+" nodes</td></tr>",highlightPath(t),l++})),n+="</table></td></tr></table>",propertiesTable.innerHTML=n}function checkboxChanged(t){var e=selectedPaths;cb=document.getElementById(t),console.log(cb.checked);var n=0;if("path_all"==t)for(n=0;n<e.length;n++)document.getElementById("path_"+n).checked=cb.checked;for(todo=document.querySelectorAll("svg *"),todo.forEach((t=>unhighlight(t.getAttribute("id")))),n=0;n<e.length;n++)document.getElementById("path_"+n).checked&&highlightPath(e[n])}function findElementsInXML(t){const e=(new DOMParser).parseFromString(xmlDoc,"text/xml"),n=[];return e.querySelectorAll("Node, Edge").forEach((e=>{t.includes(e.getAttribute("id"))&&n.push(e.getAttribute("id"))})),n}